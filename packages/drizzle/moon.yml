type: library
language: typescript
tags:
  - docker

dependsOn:
  - 'dev'

fileGroups:
  inputs:
    - './src/**/*'
    - 'package.json'
    - './drizzle.config.ts'
  migrations:
    - './migrations/**/*'

tasks:
  generate:
    description: Generate the database schema.
    command: drizzle-kit generate
    inputs:
      - '@globs(inputs)'
    outputs:
      - '@globs(migrations)'

  migrate:
    description: Run the database migrations.
    command: >
      npx tsx wait-db.ts
      drizzle-kit migrate
    local: true
    options:
      envFile:
        - '/tools/dev/.env'
    deps:
      - 'dev:db-run'
    inputs:
      - '@globs(migrations)'

  studio:
    description: Open the database studio.
    local: true
    command: drizzle-kit studio

  seed:
    description: Seed the database.
    command: npx tsx seed.ts
    inputs:
      - './seed.ts'

  docker-build:
    deps:
      - '~:generate'
    inputs:
      - '@globs(inputs)'
      - '@globs(migrations)'
    env:
      DOCKER_NAME: tanstack-start-template/drizzle

  docker-push:
    env:
      DOCKER_NAME: tanstack-start-template/drizzle
